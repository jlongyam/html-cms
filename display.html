<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,shrink-to-fit=no">
  <title>Display</title>
  <style id=style>
    :root {
      --font: 1.1rem/1.5 monospace;;
      --padding: 10px;
    }
    * { box-sizing: border-box; }
    html {
      height: 100%;
      font-size: 16px;
    }
    body {
      height: 100%;
      margin: 0;
    }
    #menu_bar {
      border-bottom: 2px solid gray;
      background-color: silver;
      padding: 5px;
      display: flex;
      flex-wrap: nowrap;
      align-content: center;
      justify-content: space-between;
      height: 46px;
    }
    .menu_button {
      font-family: monospace;
      font-size: 1.1rem;
      padding: 5px;
    }
    .menu_button:focus {
      outline: 2px solid orange;
      outline-offset: 2px;
    }
    #code_layout {
      position: relative;
      top: 0;
      bottom: 0;
      height: calc(100% - 46px);
    }
    #code_editor {
      outline: 0;
      font: var(--font);
      padding: var(--padding);
      margin: 0;
      border: 1px solid orange;
      overflow: auto;
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      border: 0;
    }
    #code_previewer {
      border: 0
      margin: 0;
      width: 100%;
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      border: 0;
    }
    #code_marker {
      border: 0;
      margin: 0;
      font: var(--font);
      outline: 0;
      resize: none;
      width: 100%;
      padding: var(--padding);
      overflow: auto;
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      border: 0;
    }
    .hide {
      visibility: hidden;
      height: 0;
      width: 0;
    }
  </style>
</head>
<body>
<div id=menu_bar>
  <button class=menu_button onclick=edit()>Edit</button>
  <button class=menu_button onclick=preview()>Preview</button>
  <button class=menu_button onclick=mark()>Mark</button>
  <button class=menu_button onclick=update()>Update</button>
</div>
<div id=code_layout>
  <pre id=code_editor contenteditable spellcheck=false>PRE</pre>
  <iframe class=hide id=code_previewer></iframe>
  <textarea class='hide' id=code_marker wrap=off onkeyup=syncTextarea()>TEXTAREA</textarea>
</div>
<script>
function downloadString(text, fileType, fileName) {
  let blob = new Blob([text], { type: fileType })
  let a = document.createElement('a');
  a.download = fileName;
  a.href = URL.createObjectURL(blob);
  a.dataset.downloadurl = [fileType, a.download, a.href].join(':');
  a.style.display = "none";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(function() { URL.revokeObjectURL(a.href); }, 1500);
}
function update() {
  let last_script = document.scripts[document.scripts.length-1]
  last_script.innerHTML = 'content(`' + code_editor.innerHTML + '`)\n'
  code_editor.innerHTML = 'PRE'
  let str = '<!doctype html>\n'
  str += '<html lang="en">\n'
  str += '<head>\n'
  str += '  <meta charset="UTF-8">\n'
  str += '  <meta name="viewport" content="width=device-width,initial-scale=1.0,shrink-to-fit=no">\n'
  str += '  <title>Display</title>\n'
  str += '  '+ document.querySelector('#style').outerHTML + '\n'
  str += '</head>\n'
  str += document.body.outerHTML + '\n'
  str += '</html>'
  let file_name = location.href.split('/').pop()
  downloadString(str,'text/html',file_name)
}
function edit() {
  code_editor.className = ''
  code_previewer.className = 'hide'
  code_marker.className = 'hide'
}
function preview() {
  code_previewer.className = ''
  code_editor.className = 'hide'
  code_marker.className = 'hide'
  let ifr_doc = code_previewer.contentWindow.document
  ifr_doc.open()
  ifr_doc.write(code_editor.textContent)
  iframe.close()
}
function mark() {
  code_marker.className = ''
  code_editor.className = 'hide'
  code_previewer.className = 'hide'
  // handle autogenerated `div`
  let sort_str = code_editor.innerHTML
  .replace('<div>','')
  .replaceAll('<div>','\n')
  .replaceAll('</div>','')
  .replaceAll('<br>','\n')
  code_marker.value = sort_str
}
function syncTextarea() {
  code_editor.innerHTML = code_marker.value
}
function content(str) {
  code_editor.innerHTML = str
}
</script>
<script>
content(`
&lt;h1&gt;Hello world&lt;/h1&gt;
&lt;p&gt;<mark>Paragraph</mark>&lt;/p&gt;
`)
</script>
</body>
</html>